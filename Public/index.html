<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>车辆油液维护管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #2c7be5;
            --light-blue: #e3f2fd;
            --accent-blue: #1a56db;
            --white: #ffffff;
            --light-gray: #f8f9fa;
            --dark-gray: #4a5568;
            --red: #e53e3e;
            --yellow: #ecc94b;
            --cyan: #00c9ff;
            --green: #38a169;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark-gray);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--accent-blue) 100%);
            color: var(--white);
            padding: 25px 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .logo i {
            font-size: 2.2rem;
        }
        
        .date-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 0.95rem;
        }
        
        .control-panel {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--primary-blue);
            color: var(--white);
        }
        
        .btn-primary:hover {
            background-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(44, 123, 229, 0.3);
        }
        
        .btn-success {
            background-color: var(--green);
            color: var(--white);
        }
        
        .btn-success:hover {
            background-color: #2d9c5e;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(56, 161, 105, 0.3);
        }
        
        .btn-warning {
            background-color: var(--yellow);
            color: #333;
        }
        
        .btn-warning:hover {
            background-color: #e0b62c;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(236, 201, 75, 0.3);
        }
        
        .tabs {
            display: flex;
            background-color: var(--white);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .tab {
            padding: 18px 30px;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark-gray);
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tab:hover {
            background-color: var(--light-gray);
        }
        
        .tab.active {
            color: var(--primary-blue);
            border-bottom: 3px solid var(--primary-blue);
            background-color: rgba(44, 123, 229, 0.05);
        }
        
        .sheet-container {
            display: none;
            background-color: var(--white);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        
        .sheet-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .sheet-title {
            font-size: 1.5rem;
            color: var(--primary-blue);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sheet-title i {
            font-size: 1.8rem;
        }
        
        .sheet-info {
            display: flex;
            gap: 20px;
            color: var(--dark-gray);
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: var(--light-gray);
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 0.9rem;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        th {
            background-color: var(--light-blue);
            padding: 18px 15px;
            text-align: left;
            font-weight: 700;
            color: var(--primary-blue);
            border-bottom: 2px solid var(--primary-blue);
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.2s;
        }
        
        tr:hover td {
            background-color: rgba(227, 242, 253, 0.3);
        }
        
        .editable-cell {
            position: relative;
        }
        
        .editable-cell input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border 0.3s;
        }
        
        .editable-cell input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(44, 123, 229, 0.1);
        }
        
        .row-red {
            background-color: rgba(229, 62, 62, 0.1) !important;
        }
        
        .row-yellow {
            background-color: rgba(236, 201, 75, 0.1) !important;
        }
        
        .row-cyan {
            background-color: rgba(0, 201, 255, 0.1) !important;
        }
        
        .alert-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge-red {
            background-color: rgba(229, 62, 62, 0.2);
            color: #c53030;
        }
        
        .badge-yellow {
            background-color: rgba(236, 201, 75, 0.2);
            color: #975a16;
        }
        
        .badge-green {
            background-color: rgba(56, 161, 105, 0.2);
            color: #276749;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background-color: var(--white);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .modal-overlay.active .modal {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.4rem;
            color: var(--primary-blue);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark-gray);
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .alert-content {
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .email-preview {
            background-color: var(--light-gray);
            padding: 20px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .email-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .email-success {
            background-color: rgba(56, 161, 105, 0.1);
            color: var(--green);
        }
        
        .email-error {
            background-color: rgba(229, 62, 62, 0.1);
            color: var(--red);
        }
        
        .footer {
            text-align: center;
            padding: 25px;
            color: var(--dark-gray);
            font-size: 0.9rem;
            margin-top: 20px;
        }
        
        .legend {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 25px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .color-red {
            background-color: rgba(229, 62, 62, 0.2);
            border: 2px solid rgba(229, 62, 62, 0.8);
        }
        
        .color-yellow {
            background-color: rgba(236, 201, 75, 0.2);
            border: 2px solid rgba(236, 201, 75, 0.8);
        }
        
        .color-cyan {
            background-color: rgba(0, 201, 255, 0.2);
            border: 2px solid rgba(0, 201, 255, 0.8);
        }
        
        .color-blue {
            background-color: rgba(44, 123, 229, 0.2);
            border: 2px solid rgba(44, 123, 229, 0.8);
        }
        
        .excluded-plate {
            background-color: #f7fafc;
            color: #a0aec0;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .control-panel {
                flex-direction: column;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                justify-content: center;
                padding: 15px;
            }
            
            .sheet-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .sheet-info {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-info">
                <div class="logo">
                    <i class="fas fa-car"></i>
                    <span>车辆油液维护管理系统</span>
                </div>
                <div class="date-display">
                    <i class="far fa-calendar-alt"></i>
                    <span id="current-date">加载日期...</span>
                </div>
            </div>
            <div class="header-stats">
                <div class="btn btn-primary" onclick="workbook.manualCheckAlerts()">
                    <i class="fas fa-bell"></i>
                    <span>检查警报</span>
                </div>
            </div>
        </header>
        
        <div class="control-panel">
            <button class="btn btn-primary" onclick="workbook.sendAlertEmail()">
                <i class="fas fa-paper-plane"></i>
                <span>发送警报邮件</span>
            </button>
            <button class="btn btn-success" onclick="workbook.addNewRow()">
                <i class="fas fa-plus-circle"></i>
                <span>添加新车辆</span>
            </button>
            <button class="btn btn-warning" onclick="workbook.clearAllData()">
                <i class="fas fa-trash-alt"></i>
                <span>清空所有数据</span>
            </button>
            <div class="legend">
                <div class="legend-item">
                    <div class="color-box color-red"></div>
                    <span>需立即维护</span>
                </div>
                <div class="legend-item">
                    <div class="color-box color-yellow"></div>
                    <span>需关注提醒</span>
                </div>
                <div class="legend-item">
                    <div class="color-box color-cyan"></div>
                    <span>需更新数据</span>
                </div>
                <div class="legend-item">
                    <div class="color-box color-blue"></div>
                    <span>正常状态</span>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-sheet="blackOil">
                <i class="fas fa-oil-can"></i>
                <span>刹车油维护</span>
            </div>
            <div class="tab" data-sheet="gearOil">
                <i class="fas fa-cogs"></i>
                <span>齿轮油维护</span>
            </div>
            <div class="tab" data-sheet="predictedChange">
                <i class="fas fa-chart-line"></i>
                <span>油液更换预测</span>
            </div>
        </div>
        
        <!-- 刹车油维护工作表 -->
        <div id="blackOil" class="sheet-container active">
            <div class="sheet-header">
                <div class="sheet-title">
                    <i class="fas fa-oil-can"></i>
                    <span>刹车油维护记录表</span>
                </div>
                <div class="sheet-info">
                    <div class="info-item">
                        <i class="fas fa-car"></i>
                        <span id="blackVehicleCount">车辆: 0</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="blackAlerts">警报: 0</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-sync-alt"></i>
                        <span>自动刷新: 开启</span>
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table id="blackOilTable">
                    <thead>
                        <tr>
                            <th width="15%">车牌号</th>
                            <th width="15%">维护日期</th>
                            <th width="12%">总里程</th>
                            <th width="12%">录入日期</th>
                            <th width="12%">消耗里程</th>
                            <th width="12%">更新日期</th>
                            <th width="12%">差值(C-E)</th>
                            <th width="10%">状态</th>
                        </tr>
                    </thead>
                    <tbody id="blackOilTableBody">
                        <!-- 数据将通过JavaScript动态添加 -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 齿轮油维护工作表 -->
        <div id="gearOil" class="sheet-container">
            <div class="sheet-header">
                <div class="sheet-title">
                    <i class="fas fa-cogs"></i>
                    <span>齿轮油维护记录表</span>
                </div>
                <div class="sheet-info">
                    <div class="info-item">
                        <i class="fas fa-car"></i>
                        <span id="gearVehicleCount">车辆: 0</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="gearAlerts">警报: 0</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-sync-alt"></i>
                        <span>自动刷新: 每秒</span>
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table id="gearOilTable">
                    <thead>
                        <tr>
                            <th width="15%">车牌号</th>
                            <th width="15%">维护日期</th>
                            <th width="12%">总里程</th>
                            <th width="12%">录入日期</th>
                            <th width="12%">消耗里程</th>
                            <th width="12%">更新日期</th>
                            <th width="12%">差值(C-E)</th>
                            <th width="10%">状态</th>
                        </tr>
                    </thead>
                    <tbody id="gearOilTableBody">
                        <!-- 数据将通过JavaScript动态添加 -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 油液更换预测工作表 -->
        <div id="predictedChange" class="sheet-container">
            <div class="sheet-header">
                <div class="sheet-title">
                    <i class="fas fa-chart-line"></i>
                    <span>油液更换预测表</span>
                </div>
                <div class="sheet-info">
                    <div class="info-item">
                        <i class="fas fa-car"></i>
                        <span id="predictedVehicleCount">车辆: 0</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="predictedAlerts">警报: 0</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-calculator"></i>
                        <span>自动计算: 开启</span>
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table id="predictedChangeTable">
                    <thead>
                        <tr>
                            <th width="12%">车牌</th>
                            <th width="12%">计划里程</th>
                            <th width="12%">黑油当前</th>
                            <th width="12%">黑油下次</th>
                            <th width="12%">黑油剩余</th>
                            <th width="12%">黑油警报</th>
                            <th width="12%">齿轮油当前</th>
                            <th width="12%">齿轮油下次</th>
                            <th width="12%">齿轮油剩余</th>
                            <th width="12%">齿轮油警报</th>
                        </tr>
                    </thead>
                    <tbody id="predictedChangeTableBody">
                        <!-- 数据将通过JavaScript动态添加 -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="footer">
            <p>© 2023 车辆油液维护管理系统 | 使用蓝白色主题设计 | 邮件接收: yongshun272@gmail.com</p>
            <p>排除车牌: QM8517L, QAA2805W, Q2805 (这些车辆的刹车油数据不会同步到齿轮油表)</p>
        </div>
    </div>
    
    <!-- 警报弹窗 -->
    <div id="alertModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="alertModalTitle">系统警报</span>
                </div>
                <button class="modal-close" onclick="workbook.closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert-content" id="alertContent">
                    <!-- 警报内容将动态添加 -->
                </div>
                <button class="btn btn-primary" onclick="workbook.closeModal()" style="width:100%;">
                    <i class="fas fa-check"></i>
                    <span>确认</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- 邮件发送弹窗 -->
    <div id="emailModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-paper-plane"></i>
                    <span>发送警报邮件</span>
                </div>
                <button class="modal-close" onclick="workbook.closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="email-preview" id="emailPreview">
                    <!-- 邮件内容将动态添加 -->
                </div>
                <div class="email-status" id="emailStatus">
                    <!-- 邮件发送状态将动态添加 -->
                </div>
                <button class="btn btn-primary" onclick="workbook.sendEmail()" style="width:100%;">
                    <i class="fas fa-paper-plane"></i>
                    <span>发送邮件到 yongshun272@gmail.com</span>
                </button>
                <button class="btn" onclick="workbook.closeModal()" style="width:100%; margin-top:10px; background-color:#e2e8f0;">
                    <span>取消</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // 车辆油液维护管理系统 - 主对象
        const workbook = {
            // 系统常量
            TO_EMAIL: "yongshun272@gmail.com",
            EXCLUDED_PLATES: ["QM8517L", "QAA2805W", "Q2805"],
            
            // 阈值设置
            BLACK_OIL_RED_THRESHOLD: 500,
            BLACK_OIL_YELLOW_THRESHOLD: 1000,
            GEAR_OIL_RED_THRESHOLD: 5000,
            GEAR_OIL_YELLOW_THRESHOLD: 10000,
            UPDATE_ALERT_DAYS: 3,
            
            // 数据存储
            blackOilData: [],
            gearOilData: [],
            predictedChangeData: [],
            
            // 当前警报
            currentAlerts: {
                brakeAlert: "",
                gearAlert: "",
                brakeUpdate: "",
                gearUpdate: ""
            },
            
            // 初始化函数
            init: function() {
                // 设置当前日期
                const now = new Date();
                const formattedDate = now.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).replace(/\//g, '-');
                document.getElementById('current-date').textContent = formattedDate;
                
                // 初始化标签切换功能
                this.initTabs();
                
                // 加载示例数据
                this.loadSampleData();
                
                // 初始化表格
                this.renderAllSheets();
                
                // 启动齿轮油表的自动刷新
                this.startAutoRefresh();
                
                // 绑定事件监听器
                this.bindEvents();
                
                console.log("车辆油液维护管理系统初始化完成");
            },
            
            // 初始化标签切换
            initTabs: function() {
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        // 移除所有标签的active类
                        tabs.forEach(t => t.classList.remove('active'));
                        
                        // 添加当前标签的active类
                        tab.classList.add('active');
                        
                        // 隐藏所有工作表
                        const sheetContainers = document.querySelectorAll('.sheet-container');
                        sheetContainers.forEach(container => {
                            container.classList.remove('active');
                        });
                        
                        // 显示选中的工作表
                        const sheetId = tab.getAttribute('data-sheet');
                        document.getElementById(sheetId).classList.add('active');
                    });
                });
            },
            
            // 加载示例数据
            loadSampleData: function() {
                // 刹车油示例数据
                this.blackOilData = [
                    { plate: "QAB1234X", maintenanceDate: this.addDays(new Date(), 30), totalMileage: 85000, entryDate: new Date(), consumption: 82000, updateDate: this.addDays(new Date(), -2), diff: 3000 },
                    { plate: "QCD5678Y", maintenanceDate: this.addDays(new Date(), -5), totalMileage: 120000, entryDate: this.addDays(new Date(), -10), consumption: 119000, updateDate: this.addDays(new Date(), -1), diff: 1000 },
                    { plate: "QEF9012Z", maintenanceDate: this.addDays(new Date(), 90), totalMileage: 65000, entryDate: this.addDays(new Date(), -15), consumption: 64000, updateDate: this.addDays(new Date(), -5), diff: 1000 },
                    { plate: "QM8517L", maintenanceDate: this.addDays(new Date(), 60), totalMileage: 55000, entryDate: this.addDays(new Date(), -20), consumption: 54000, updateDate: new Date(), diff: 1000 },
                    { plate: "QGH3456A", maintenanceDate: this.addDays(new Date(), 120), totalMileage: 95000, entryDate: this.addDays(new Date(), -25), consumption: 93000, updateDate: this.addDays(new Date(), -10), diff: 2000 }
                ];
                
                // 齿轮油示例数据
                this.gearOilData = [
                    { plate: "QAB1234X", maintenanceDate: this.addDays(new Date(), 30), totalMileage: 85000, entryDate: new Date(), consumption: 80000, updateDate: this.addDays(new Date(), -1), diff: 5000 },
                    { plate: "QCD5678Y", maintenanceDate: this.addDays(new Date(), -5), totalMileage: 120000, entryDate: this.addDays(new Date(), -10), consumption: 115000, updateDate: new Date(), diff: 5000 },
                    { plate: "QEF9012Z", maintenanceDate: this.addDays(new Date(), 90), totalMileage: 65000, entryDate: this.addDays(new Date(), -15), consumption: 60000, updateDate: this.addDays(new Date(), -4), diff: 5000 },
                    { plate: "QGH3456A", maintenanceDate: this.addDays(new Date(), 120), totalMileage: 95000, entryDate: this.addDays(new Date(), -25), consumption: 90000, updateDate: this.addDays(new Date(), -15), diff: 5000 }
                ];
                
                // 预测更换示例数据
                this.predictedChangeData = [
                    { plate: "QAB1234X", plannedMileage: 5000, blackCurrent: 82000, blackNext: 85000, blackRemaining: 3000, gearCurrent: 80000, gearNext: 85000, gearRemaining: 5000 },
                    { plate: "QCD5678Y", plannedMileage: 3000, blackCurrent: 119000, blackNext: 120000, blackRemaining: 1000, gearCurrent: 115000, gearNext: 120000, gearRemaining: 5000 }
                ];
            },
            
            // 渲染所有工作表
            renderAllSheets: function() {
                this.renderBlackOilSheet();
                this.renderGearOilSheet();
                this.renderPredictedChangeSheet();
                
                // 更新统计信息
                this.updateStats();
            },
            
            // 渲染刹车油工作表
            renderBlackOilSheet: function() {
                const tableBody = document.getElementById('blackOilTableBody');
                tableBody.innerHTML = '';
                
                this.blackOilData.forEach((row, index) => {
                    const rowElement = document.createElement('tr');
                    
                    // 计算行颜色类
                    let rowClass = '';
                    if (row.diff <= this.BLACK_OIL_RED_THRESHOLD) {
                        rowClass = 'row-red';
                    } else if (row.diff <= this.BLACK_OIL_YELLOW_THRESHOLD) {
                        rowClass = 'row-yellow';
                    } else if (row.updateDate && this.daysDiff(row.updateDate, new Date()) > this.UPDATE_ALERT_DAYS) {
                        rowClass = 'row-cyan';
                    }
                    
                    rowElement.className = rowClass;
                    
                    // 检查维护日期是否过期
                    if (row.maintenanceDate <= new Date()) {
                        rowClass = 'row-red';
                        rowElement.className = 'row-red';
                    }
                    
                    // 检查是否是排除的车牌
                    const isExcluded = this.EXCLUDED_PLATES.includes(row.plate);
                    
                    rowElement.innerHTML = `
                        <td class="editable-cell ${isExcluded ? 'excluded-plate' : ''}">
                            <input type="text" value="${row.plate}" data-row="${index}" data-col="plate" onchange="workbook.updateBlackOilCell(this)" ${isExcluded ? 'disabled' : ''}>
                        </td>
                        <td class="editable-cell">
                            <input type="date" value="${this.formatDateForInput(row.maintenanceDate)}" data-row="${index}" data-col="maintenanceDate" onchange="workbook.updateBlackOilCell(this)">
                        </td>
                        <td class="editable-cell">
                            <input type="number" value="${row.totalMileage}" data-row="${index}" data-col="totalMileage" onchange="workbook.updateBlackOilCell(this)">
                        </td>
                        <td class="editable-cell">
                            <input type="date" value="${this.formatDateForInput(row.entryDate)}" data-row="${index}" data-col="entryDate" onchange="workbook.updateBlackOilCell(this)">
                        </td>
                        <td class="editable-cell ${isExcluded ? 'excluded-plate' : ''}">
                            <input type="number" value="${row.consumption}" data-row="${index}" data-col="consumption" onchange="workbook.updateBlackOilCell(this)" ${isExcluded ? 'disabled' : ''}>
                        </td>
                        <td class="editable-cell">
                            <input type="date" value="${this.formatDateForInput(row.updateDate)}" data-row="${index}" data-col="updateDate" onchange="workbook.updateBlackOilCell(this)">
                        </td>
                        <td>${row.diff}</td>
                        <td>
                            ${this.getStatusBadge(row.diff, 'black')}
                        </td>
                    `;
                    
                    tableBody.appendChild(rowElement);
                });
                
                // 更新车辆计数
                document.getElementById('blackVehicleCount').textContent = `车辆: ${this.blackOilData.length}`;
            },
            
            // 渲染齿轮油工作表
            renderGearOilSheet: function() {
                const tableBody = document.getElementById('gearOilTableBody');
                tableBody.innerHTML = '';
                
                this.gearOilData.forEach((row, index) => {
                    const rowElement = document.createElement('tr');
                    
                    // 计算行颜色类
                    let rowClass = '';
                    if (row.diff <= this.GEAR_OIL_RED_THRESHOLD) {
                        rowClass = 'row-red';
                    } else if (row.diff <= this.GEAR_OIL_YELLOW_THRESHOLD) {
                        rowClass = 'row-yellow';
                    } else if (row.updateDate && this.daysDiff(row.updateDate, new Date()) > this.UPDATE_ALERT_DAYS) {
                        rowClass = 'row-cyan';
                    }
                    
                    rowElement.className = rowClass;
                    
                    // 检查维护日期是否过期
                    if (row.maintenanceDate <= new Date()) {
                        rowClass = 'row-red';
                        rowElement.className = 'row-red';
                    }
                    
                    rowElement.innerHTML = `
                        <td class="editable-cell">
                            <input type="text" value="${row.plate}" data-row="${index}" data-col="plate" onchange="workbook.updateGearOilCell(this)">
                        </td>
                        <td class="editable-cell">
                            <input type="date" value="${this.formatDateForInput(row.maintenanceDate)}" data-row="${index}" data-col="maintenanceDate" onchange="workbook.updateGearOilCell(this)">
                        </td>
                        <td class="editable-cell">
                            <input type="number" value="${row.totalMileage}" data-row="${index}" data-col="totalMileage" onchange="workbook.updateGearOilCell(this)">
                        </td>
                        <td class="editable-cell">
                            <input type="date" value="${this.formatDateForInput(row.entryDate)}" data-row="${index}" data-col="entryDate" onchange="workbook.updateGearOilCell(this)">
                        </td>
                        <td class="editable-cell">
                            <input type="number" value="${row.consumption}" data-row="${index}" data-col="consumption" onchange="workbook.updateGearOilCell(this)">
                        </td>
                        <td class="editable-cell">
                            <input type="date" value="${this.formatDateForInput(row.updateDate)}" data-row="${index}" data-col="updateDate" onchange="workbook.updateGearOilCell(this)">
                        </td>
                        <td>${row.diff}</td>
                        <td>
                            ${this.getStatusBadge(row.diff, 'gear')}
                        </td>
                    `;
                    
                    tableBody.appendChild(rowElement);
                });
                
                // 更新车辆计数
                document.getElementById('gearVehicleCount').textContent = `车辆: ${this.gearOilData.length}`;
            },
            
            // 渲染预测更换工作表
            renderPredictedChangeSheet: function() {
                const tableBody = document.getElementById('predictedChangeTableBody');
                tableBody.innerHTML = '';
                
                this.predictedChangeData.forEach((row, index) => {
                    // 计算警报状态
                    const blackAlert = row.blackRemaining <= 0 ? 
                        '<span class="alert-badge badge-red">需更换刹车油</span>' : 
                        row.blackRemaining <= 1000 ? 
                        '<span class="alert-badge badge-yellow">刹车油提醒</span>' : 
                        '<span class="alert-badge badge-green">刹车油安全</span>';
                    
                    const gearAlert = row.gearRemaining <= 0 ? 
                        '<span class="alert-badge badge-red">需更换齿轮油</span>' : 
                        row.gearRemaining <= 1000 ? 
                        '<span class="alert-badge badge-yellow">齿轮油提醒</span>' : 
                        '<span class="alert-badge badge-green">齿轮油安全</span>';
                    
                    const rowElement = document.createElement('tr');
                    rowElement.innerHTML = `
                        <td class="editable-cell">
                            <input type="text" value="${row.plate}" data-row="${index}" data-col="plate" onchange="workbook.updatePredictedCell(this)">
                        </td>
                        <td class="editable-cell">
                            <input type="number" value="${row.plannedMileage}" data-row="${index}" data-col="plannedMileage" onchange="workbook.updatePredictedCell(this)">
                        </td>
                        <td>${row.blackCurrent}</td>
                        <td>${row.blackNext}</td>
                        <td>${row.blackRemaining}</td>
                        <td>${blackAlert}</td>
                        <td>${row.gearCurrent}</td>
                        <td>${row.gearNext}</td>
                        <td>${row.gearRemaining}</td>
                        <td>${gearAlert}</td>
                    `;
                    
                    tableBody.appendChild(rowElement);
                });
                
                // 更新车辆计数
                document.getElementById('predictedVehicleCount').textContent = `车辆: ${this.predictedChangeData.length}`;
            },
            
            // 更新刹车油单元格
            updateBlackOilCell: function(input) {
                const rowIndex = parseInt(input.getAttribute('data-row'));
                const col = input.getAttribute('data-col');
                const value = input.value;
                
                if (rowIndex >= 0 && rowIndex < this.blackOilData.length) {
                    // 根据列类型处理值
                    if (col === 'plate') {
                        // 车牌号重复检查
                        if (value && this.isPlateDuplicate(value, rowIndex, 'black')) {
                            this.showAlert("车牌号重复", "请输入唯一的车牌号。", "warning");
                            input.value = this.blackOilData[rowIndex].plate;
                            return;
                        }
                        this.blackOilData[rowIndex].plate = value;
                    } else if (col === 'maintenanceDate') {
                        this.blackOilData[rowIndex].maintenanceDate = new Date(value);
                    } else if (col === 'totalMileage') {
                        const numValue = parseFloat(value);
                        if (isNaN(numValue) || numValue <= 0) {
                            this.showAlert("无效值", "总里程必须是正数！", "error");
                            input.value = this.blackOilData[rowIndex].totalMileage;
                            return;
                        }
                        
                        // 保存旧值用于撤销
                        const oldValue = this.blackOilData[rowIndex].totalMileage;
                        this.blackOilData[rowIndex].totalMileage = numValue;
                        
                        // 更新相关字段
                        this.blackOilData[rowIndex].entryDate = new Date();
                        this.blackOilData[rowIndex].maintenanceDate = this.addDays(new Date(), 365); // 一年后
                        
                        // 重新计算差值
                        this.blackOilData[rowIndex].diff = numValue - this.blackOilData[rowIndex].consumption;
                        
                        // 同步到齿轮油表（如果车牌不在排除列表中）
                        if (!this.EXCLUDED_PLATES.includes(this.blackOilData[rowIndex].plate)) {
                            this.syncToGearOil(this.blackOilData[rowIndex].plate, 'totalMileage', numValue);
                        }
                    } else if (col === 'entryDate') {
                        const dateValue = new Date(value);
                        if (isNaN(dateValue.getTime())) {
                            this.showAlert("无效日期", "录入日期必须是有效日期！", "error");
                            input.value = this.formatDateForInput(this.blackOilData[rowIndex].entryDate);
                            return;
                        }
                        this.blackOilData[rowIndex].entryDate = dateValue;
                    } else if (col === 'consumption') {
                        const numValue = parseFloat(value);
                        if (isNaN(numValue) || numValue <= 0) {
                            this.showAlert("无效值", "消耗里程必须是正数！", "error");
                            input.value = this.blackOilData[rowIndex].consumption;
                            return;
                        }
                        
                        // 保存旧值用于撤销
                        const oldValue = this.blackOilData[rowIndex].consumption;
                        
                        // 检查差值限制
                        const totalMileage = this.blackOilData[rowIndex].totalMileage;
                        const diffCE = totalMileage - numValue;
                        if (diffCE < -2000) {
                            this.showAlert("差值超限", "C-E差值不能小于-2000！请调整。", "error");
                            input.value = oldValue;
                            return;
                        }
                        
                        // 如果值减少，请求确认
                        if (numValue < oldValue) {
                            if (!confirm(`将消耗里程从 ${oldValue} 减少到 ${numValue}？\n(确定=继续，取消=撤销)`)) {
                                input.value = oldValue;
                                return;
                            }
                        }
                        
                        this.blackOilData[rowIndex].consumption = numValue;
                        this.blackOilData[rowIndex].updateDate = new Date();
                        this.blackOilData[rowIndex].diff = totalMileage - numValue;
                        
                        // 同步到齿轮油表（如果车牌不在排除列表中）
                        if (!this.EXCLUDED_PLATES.includes(this.blackOilData[rowIndex].plate)) {
                            this.syncToGearOil(this.blackOilData[rowIndex].plate, 'consumption', numValue);
                        }
                    } else if (col === 'updateDate') {
                        const dateValue = new Date(value);
                        if (isNaN(dateValue.getTime())) {
                            this.showAlert("无效日期", "更新日期必须是有效日期！", "error");
                            input.value = this.formatDateForInput(this.blackOilData[rowIndex].updateDate);
                            return;
                        }
                        this.blackOilData[rowIndex].updateDate = dateValue;
                        
                        // 如果修改了更新日期，同步更新维护日期
                        this.blackOilData[rowIndex].maintenanceDate = this.addDays(dateValue, 365);
                    }
                    
                    // 重新渲染表格以更新颜色和状态
                    this.renderBlackOilSheet();
                    this.updateStats();
                }
            },
            
            // 更新齿轮油单元格
            updateGearOilCell: function(input) {
                const rowIndex = parseInt(input.getAttribute('data-row'));
                const col = input.getAttribute('data-col');
                const value = input.value;
                
                if (rowIndex >= 0 && rowIndex < this.gearOilData.length) {
                    // 根据列类型处理值
                    if (col === 'plate') {
                        // 车牌号重复检查
                        if (value && this.isPlateDuplicate(value, rowIndex, 'gear')) {
                            this.showAlert("车牌号重复", "请输入唯一的车牌号。", "warning");
                            input.value = this.gearOilData[rowIndex].plate;
                            return;
                        }
                        this.gearOilData[rowIndex].plate = value;
                    } else if (col === 'maintenanceDate') {
                        this.gearOilData[rowIndex].maintenanceDate = new Date(value);
                    } else if (col === 'totalMileage') {
                        const numValue = parseFloat(value);
                        if (isNaN(numValue) || numValue <= 0) {
                            this.showAlert("无效值", "总里程必须是正数！", "error");
                            input.value = this.gearOilData[rowIndex].totalMileage;
                            return;
                        }
                        
                        // 保存旧值用于撤销
                        const oldValue = this.gearOilData[rowIndex].totalMileage;
                        this.gearOilData[rowIndex].totalMileage = numValue;
                        
                        // 更新相关字段
                        this.gearOilData[rowIndex].entryDate = new Date();
                        this.gearOilData[rowIndex].maintenanceDate = this.addDays(new Date(), 365); // 一年后
                        
                        // 重新计算差值
                        this.gearOilData[rowIndex].diff = numValue - this.gearOilData[rowIndex].consumption;
                    } else if (col === 'entryDate') {
                        const dateValue = new Date(value);
                        if (isNaN(dateValue.getTime())) {
                            this.showAlert("无效日期", "录入日期必须是有效日期！", "error");
                            input.value = this.formatDateForInput(this.gearOilData[rowIndex].entryDate);
                            return;
                        }
                        this.gearOilData[rowIndex].entryDate = dateValue;
                    } else if (col === 'consumption') {
                        const numValue = parseFloat(value);
                        if (isNaN(numValue) || numValue <= 0) {
                            this.showAlert("无效值", "消耗里程必须是正数！", "error");
                            input.value = this.gearOilData[rowIndex].consumption;
                            return;
                        }
                        
                        // 保存旧值用于撤销
                        const oldValue = this.gearOilData[rowIndex].consumption;
                        
                        // 检查差值限制
                        const totalMileage = this.gearOilData[rowIndex].totalMileage;
                        const diffCE = totalMileage - numValue;
                        if (diffCE < -10000) {
                            this.showAlert("差值超限", "C-E差值不能小于-10000！请调整。", "error");
                            input.value = oldValue;
                            return;
                        }
                        
                        // 如果值减少，请求确认
                        if (numValue < oldValue) {
                            if (!confirm(`将消耗里程从 ${oldValue} 减少到 ${numValue}？\n(确定=继续，取消=撤销)`)) {
                                input.value = oldValue;
                                return;
                            }
                        }
                        
                        this.gearOilData[rowIndex].consumption = numValue;
                        this.gearOilData[rowIndex].updateDate = new Date();
                        this.gearOilData[rowIndex].diff = totalMileage - numValue;
                    } else if (col === 'updateDate') {
                        const dateValue = new Date(value);
                        if (isNaN(dateValue.getTime())) {
                            this.showAlert("无效日期", "更新日期必须是有效日期！", "error");
                            input.value = this.formatDateForInput(this.gearOilData[rowIndex].updateDate);
                            return;
                        }
                        this.gearOilData[rowIndex].updateDate = dateValue;
                        
                        // 如果修改了更新日期，同步更新维护日期
                        this.gearOilData[rowIndex].maintenanceDate = this.addDays(dateValue, 365);
                    }
                    
                    // 重新渲染表格以更新颜色和状态
                    this.renderGearOilSheet();
                    this.updateStats();
                }
            },
            
            // 更新预测单元格
            updatePredictedCell: function(input) {
                const rowIndex = parseInt(input.getAttribute('data-row'));
                const col = input.getAttribute('data-col');
                const value = input.value;
                
                if (rowIndex >= 0 && rowIndex < this.predictedChangeData.length) {
                    if (col === 'plate') {
                        this.predictedChangeData[rowIndex].plate = value;
                    } else if (col === 'plannedMileage') {
                        const numValue = parseFloat(value);
                        if (isNaN(numValue) || numValue <= 0) {
                            this.showAlert("无效值", "计划里程必须是正数！", "error");
                            input.value = this.predictedChangeData[rowIndex].plannedMileage;
                            return;
                        }
                        
                        this.predictedChangeData[rowIndex].plannedMileage = numValue;
                        
                        // 重新计算剩余里程
                        this.predictedChangeData[rowIndex].blackRemaining = 
                            this.predictedChangeData[rowIndex].blackNext - 
                            this.predictedChangeData[rowIndex].blackCurrent - 
                            numValue;
                            
                        this.predictedChangeData[rowIndex].gearRemaining = 
                            this.predictedChangeData[rowIndex].gearNext - 
                            this.predictedChangeData[rowIndex].gearCurrent - 
                            numValue;
                    }
                    
                    // 重新渲染预测表
                    this.renderPredictedChangeSheet();
                    this.updateStats();
                }
            },
            
            // 同步数据到齿轮油表
            syncToGearOil: function(plate, field, value) {
                // 在齿轮油数据中查找相同车牌
                const gearIndex = this.gearOilData.findIndex(row => row.plate === plate);
                if (gearIndex !== -1) {
                    if (field === 'consumption') {
                        this.gearOilData[gearIndex].consumption = value;
                        this.gearOilData[gearIndex].updateDate = new Date();
                        this.gearOilData[gearIndex].diff = this.gearOilData[gearIndex].totalMileage - value;
                    } else if (field === 'totalMileage') {
                        this.gearOilData[gearIndex].totalMileage = value;
                        this.gearOilData[gearIndex].entryDate = new Date();
                        this.gearOilData[gearIndex].maintenanceDate = this.addDays(new Date(), 365);
                        this.gearOilData[gearIndex].diff = value - this.gearOilData[gearIndex].consumption;
                    }
                    
                    // 重新渲染齿轮油表
                    this.renderGearOilSheet();
                }
            },
            
            // 检查车牌是否重复
            isPlateDuplicate: function(plate, currentIndex, sheetType) {
                if (sheetType === 'black') {
                    return this.blackOilData.some((row, index) => 
                        index !== currentIndex && row.plate === plate
                    );
                } else if (sheetType === 'gear') {
                    return this.gearOilData.some((row, index) => 
                        index !== currentIndex && row.plate === plate
                    );
                }
                return false;
            },
            
            // 获取状态徽章
            getStatusBadge: function(diff, oilType) {
                if (oilType === 'black') {
                    if (diff <= this.BLACK_OIL_RED_THRESHOLD) {
                        return '<span class="alert-badge badge-red">需立即更换</span>';
                    } else if (diff <= this.BLACK_OIL_YELLOW_THRESHOLD) {
                        return '<span class="alert-badge badge-yellow">需关注提醒</span>';
                    } else {
                        return '<span class="alert-badge badge-green">正常</span>';
                    }
                } else if (oilType === 'gear') {
                    if (diff <= this.GEAR_OIL_RED_THRESHOLD) {
                        return '<span class="alert-badge badge-red">需立即更换</span>';
                    } else if (diff <= this.GEAR_OIL_YELLOW_THRESHOLD) {
                        return '<span class="alert-badge badge-yellow">需关注提醒</span>';
                    } else {
                        return '<span class="alert-badge badge-green">正常</span>';
                    }
                }
                return '';
            },
            
            // 手动检查警报
            manualCheckAlerts: function() {
                this.checkAlerts();
                this.showAlert("检查完成", "警报检查已成功完成！", "info");
            },
            
            // 检查所有警报
            checkAlerts: function() {
                // 清空当前警报
                this.currentAlerts = {
                    brakeAlert: "",
                    gearAlert: "",
                    brakeUpdate: "",
                    gearUpdate: ""
                };
                
                // 检查刹车油警报
                let brakeAlertMsg = "";
                this.blackOilData.forEach(row => {
                    if (row.diff <= this.BLACK_OIL_YELLOW_THRESHOLD) {
                        brakeAlertMsg += `车牌: ${row.plate}\n剩余: ${row.diff} 公里 - 刹车油即将过期\n\n`;
                    }
                });
                this.currentAlerts.brakeAlert = brakeAlertMsg;
                
                // 检查齿轮油警报
                let gearAlertMsg = "";
                this.gearOilData.forEach(row => {
                    if (row.diff <= this.GEAR_OIL_YELLOW_THRESHOLD) {
                        gearAlertMsg += `车牌: ${row.plate}\n剩余: ${row.diff} 公里 - 齿轮油即将过期\n\n`;
                    }
                });
                this.currentAlerts.gearAlert = gearAlertMsg;
                
                // 检查刹车油更新警报
                let brakeUpdateMsg = "";
                this.blackOilData.forEach(row => {
                    if (row.updateDate && this.daysDiff(row.updateDate, new Date()) > this.UPDATE_ALERT_DAYS) {
                        brakeUpdateMsg += `车牌: ${row.plate}\n最后更新: ${this.formatDate(row.updateDate)}\n需要更新消耗数据\n\n`;
                    }
                });
                this.currentAlerts.brakeUpdate = brakeUpdateMsg;
                
                // 检查齿轮油更新警报
                let gearUpdateMsg = "";
                this.gearOilData.forEach(row => {
                    if (row.updateDate && this.daysDiff(row.updateDate, new Date()) > this.UPDATE_ALERT_DAYS) {
                        gearUpdateMsg += `车牌: ${row.plate}\n最后更新: ${this.formatDate(row.updateDate)}\n需要更新消耗数据\n\n`;
                    }
                });
                this.currentAlerts.gearUpdate = gearUpdateMsg;
                
                // 显示警报（如果有）
                if (brakeAlertMsg) {
                    this.showAlert("刹车油更换警报", brakeAlertMsg, "warning");
                }
                if (gearAlertMsg) {
                    this.showAlert("齿轮油更换警报", gearAlertMsg, "warning");
                }
                if (brakeUpdateMsg) {
                    this.showAlert("刹车油更新警报", brakeUpdateMsg, "info");
                }
                if (gearUpdateMsg) {
                    this.showAlert("齿轮油更新警报", gearUpdateMsg, "info");
                }
                
                // 更新警报计数
                this.updateStats();
                
                return this.currentAlerts;
            },
            
            // 发送警报邮件
            sendAlertEmail: function() {
                // 检查警报
                const alerts = this.checkAlerts();
                
                // 构建邮件内容
                let emailBody = "";
                if (alerts.brakeAlert) {
                    emailBody += "=== 刹车油更换警报 ===\n" + alerts.brakeAlert + "\n";
                }
                if (alerts.gearAlert) {
                    emailBody += "=== 齿轮油更换警报 ===\n" + alerts.gearAlert + "\n";
                }
                if (alerts.brakeUpdate) {
                    emailBody += "=== 刹车油更新警报 ===\n" + alerts.brakeUpdate + "\n";
                }
                if (alerts.gearUpdate) {
                    emailBody += "=== 齿轮油更新警报 ===\n" + alerts.gearUpdate;
                }
                
                // 如果没有警报，显示消息
                if (!emailBody.trim()) {
                    this.showAlert("无警报", "当前没有需要发送的警报。", "info");
                    return;
                }
                
                // 显示邮件预览
                document.getElementById('emailPreview').textContent = emailBody;
                document.getElementById('emailStatus').innerHTML = '';
                document.getElementById('emailModal').classList.add('active');
            },
            
            // 发送邮件（模拟）
            sendEmail: function() {
                const emailStatus = document.getElementById('emailStatus');
                
                // 模拟发送过程
                emailStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>正在发送邮件...</span>';
                emailStatus.className = 'email-status';
                
                // 模拟网络延迟
                setTimeout(() => {
                    // 90%的成功率模拟
                    if (Math.random() > 0.1) {
                        emailStatus.innerHTML = '<i class="fas fa-check-circle"></i><span>邮件已成功发送到 ' + this.TO_EMAIL + '</span>';
                        emailStatus.className = 'email-status email-success';
                    } else {
                        emailStatus.innerHTML = '<i class="fas fa-times-circle"></i><span>邮件发送失败，请稍后重试</span>';
                        emailStatus.className = 'email-status email-error';
                    }
                }, 1500);
            },
            
            // 显示警报
            showAlert: function(title, message, type = "info") {
                document.getElementById('alertModalTitle').textContent = title;
                document.getElementById('alertContent').textContent = message;
                document.getElementById('alertModal').classList.add('active');
            },
            
            // 关闭弹窗
            closeModal: function() {
                document.getElementById('alertModal').classList.remove('active');
                document.getElementById('emailModal').classList.remove('active');
            },
            
            // 添加新行
            addNewRow: function() {
                // 获取当前激活的工作表
                const activeTab = document.querySelector('.tab.active');
                const sheetId = activeTab.getAttribute('data-sheet');
                
                if (sheetId === 'blackOil') {
                    // 在刹车油表中添加新行
                    this.blackOilData.push({
                        plate: `NEW${this.blackOilData.length + 1}`,
                        maintenanceDate: this.addDays(new Date(), 365),
                        totalMileage: 0,
                        entryDate: new Date(),
                        consumption: 0,
                        updateDate: new Date(),
                        diff: 0
                    });
                    this.renderBlackOilSheet();
                } else if (sheetId === 'gearOil') {
                    // 在齿轮油表中添加新行
                    this.gearOilData.push({
                        plate: `NEW${this.gearOilData.length + 1}`,
                        maintenanceDate: this.addDays(new Date(), 365),
                        totalMileage: 0,
                        entryDate: new Date(),
                        consumption: 0,
                        updateDate: new Date(),
                        diff: 0
                    });
                    this.renderGearOilSheet();
                } else if (sheetId === 'predictedChange') {
                    // 在预测表中添加新行
                    this.predictedChangeData.push({
                        plate: `NEW${this.predictedChangeData.length + 1}`,
                        plannedMileage: 0,
                        blackCurrent: 0,
                        blackNext: 0,
                        blackRemaining: 0,
                        gearCurrent: 0,
                        gearNext: 0,
                        gearRemaining: 0
                    });
                    this.renderPredictedChangeSheet();
                }
                
                this.updateStats();
                this.showAlert("添加成功", "已成功添加新车辆记录。", "info");
            },
            
            // 清空所有数据
            clearAllData: function() {
                if (confirm("确定要清空所有数据吗？此操作不可撤销。")) {
                    this.blackOilData = [];
                    this.gearOilData = [];
                    this.predictedChangeData = [];
                    
                    this.renderAllSheets();
                    this.showAlert("数据已清空", "所有数据已被成功清空。", "info");
                }
            },
            
            // 启动自动刷新
            startAutoRefresh: function() {
                // 齿轮油表每秒自动刷新
                setInterval(() => {
                    this.fullBatchUpdateGearOil();
                }, 1000);
            },
            
            // 齿轮油表批量更新
            fullBatchUpdateGearOil: function() {
                // 在实际应用中，这里会重新计算所有行的颜色和状态
                // 为了演示，我们只是随机更新一些行的颜色来模拟自动刷新
                const rows = document.querySelectorAll('#gearOilTableBody tr');
                if (rows.length > 0) {
                    // 随机选择一行更新其颜色（演示效果）
                    const randomRow = rows[Math.floor(Math.random() * rows.length)];
                    
                    // 如果行已经有颜色类，则移除并重新添加以模拟刷新
                    if (randomRow.classList.contains('row-cyan')) {
                        randomRow.classList.remove('row-cyan');
                        setTimeout(() => {
                            randomRow.classList.add('row-cyan');
                        }, 100);
                    }
                }
            },
            
            // 更新统计信息
            updateStats: function() {
                // 计算刹车油警报数量
                let blackAlertsCount = 0;
                this.blackOilData.forEach(row => {
                    if (row.diff <= this.BLACK_OIL_YELLOW_THRESHOLD) {
                        blackAlertsCount++;
                    }
                    if (row.updateDate && this.daysDiff(row.updateDate, new Date()) > this.UPDATE_ALERT_DAYS) {
                        blackAlertsCount++;
                    }
                    if (row.maintenanceDate <= new Date()) {
                        blackAlertsCount++;
                    }
                });
                document.getElementById('blackAlerts').textContent = `警报: ${blackAlertsCount}`;
                
                // 计算齿轮油警报数量
                let gearAlertsCount = 0;
                this.gearOilData.forEach(row => {
                    if (row.diff <= this.GEAR_OIL_YELLOW_THRESHOLD) {
                        gearAlertsCount++;
                    }
                    if (row.updateDate && this.daysDiff(row.updateDate, new Date()) > this.UPDATE_ALERT_DAYS) {
                        gearAlertsCount++;
                    }
                    if (row.maintenanceDate <= new Date()) {
                        gearAlertsCount++;
                    }
                });
                document.getElementById('gearAlerts').textContent = `警报: ${gearAlertsCount}`;
                
                // 计算预测警报数量
                let predictedAlertsCount = 0;
                this.predictedChangeData.forEach(row => {
                    if (row.blackRemaining <= 1000 || row.gearRemaining <= 1000) {
                        predictedAlertsCount++;
                    }
                });
                document.getElementById('predictedAlerts').textContent = `警报: ${predictedAlertsCount}`;
            },
            
            // 绑定事件监听器
            bindEvents: function() {
                // 绑定键盘快捷键
                document.addEventListener('keydown', (e) => {
                    // Ctrl+S 保存/检查警报
                    if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        this.manualCheckAlerts();
                    }
                    
                    // Ctrl+E 发送邮件
                    if (e.ctrlKey && e.key === 'e') {
                        e.preventDefault();
                        this.sendAlertEmail();
                    }
                });
                
                // 绑定表格单元格点击事件
                document.addEventListener('click', (e) => {
                    // 如果点击的是可编辑单元格内的输入框，阻止事件冒泡
                    if (e.target.tagName === 'INPUT' && e.target.closest('.editable-cell')) {
                        e.stopPropagation();
                    }
                });
            },
            
            // 工具函数：日期格式化
            formatDate: function(date) {
                if (!date) return '';
                const d = new Date(date);
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                return `${day}/${month}/${year}`;
            },
            
            // 工具函数：为输入框格式化日期
            formatDateForInput: function(date) {
                if (!date) return '';
                const d = new Date(date);
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                return `${year}-${month}-${day}`;
            },
            
            // 工具函数：添加天数
            addDays: function(date, days) {
                const result = new Date(date);
                result.setDate(result.getDate() + days);
                return result;
            },
            
            // 工具函数：计算日期差
            daysDiff: function(date1, date2) {
                const timeDiff = Math.abs(new Date(date2) - new Date(date1));
                return Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
            }
        };
        
        // 页面加载完成后初始化系统
        document.addEventListener('DOMContentLoaded', function() {
            workbook.init();
        });
    </script>
</body>
</html>